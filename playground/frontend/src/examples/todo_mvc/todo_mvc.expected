# TodoMVC example - comprehensive CRUD test
#
# NOTE: This example starts with 2 pre-populated todos:
#   - "Buy groceries"
#   - "Clean room"
#
# Test Flow:
# 1. Input ready checks (BUG #1: auto-focus on start)
# 2. FILTER TESTS (with initial todos only)
#    + BUG #2: Input should NOT re-focus after filter click
# 3. Add multiple todos
# 4. Toggle dynamic todo (BUG #3: checkbox isolation test)
# 5. Toggle complete (check/uncheck)
# 6. Toggle all
# 7. Check different todo
# 8. Edit todo (double-click)
# 9. Escape cancel edit
# 10. Delete todo
# 11. Clear completed (BUG #4: must remove correct todos)
# 12. Persistence checks

[test]
category = "interactive"
description = "TodoMVC: add, complete, toggle, edit, delete, filter, clear, and persist todos"

[output]
# Initial state has 2 pre-populated todos
text = "2 items left"

[timing]
timeout = 15000
poll_interval = 200

# ============================================
# SECTION 1: INPUT READY
# ============================================

[[sequence]]
description = "Verify input has focus (focus: True in Boon code)"
actions = [["assert_focused", 0]]
expect = "2 items left"

[[sequence]]
description = "Verify input is actually typeable (not disabled/readonly/hidden)"
actions = [["assert_input_typeable", 0]]
expect = "2 items left"

[[sequence]]
description = "BUG TEST #C: All filter button has outline at app startup (before any clicks)"
actions = [["assert_button_has_outline", "All"]]
expect = "2 items left"

# ============================================
# SECTION 1b: BUG TEST - ADD TODO (early test for critical bug)
# This tests that adding a new todo works at all - if this fails,
# the DD engine is broken for text input handling.
# ============================================

[[sequence]]
description = "BUG TEST: Initial todos should have visible checkboxes (3 checkboxes: toggle-all + 2 todos)"
actions = [["assert_checkbox_count", 3]]
expect = "2 items left"

[[sequence]]
description = "BUG TEST: Type 'Test todo' in the input"
actions = [["type", "Test todo"]]
expect = "2 items left"

[[sequence]]
description = "BUG TEST: Press Enter to add the todo"
actions = [["key", "Enter"]]
expect = "3 items left"

[[sequence]]
description = "BUG TEST: After adding, should have 4 checkboxes (toggle-all + 3 todos)"
actions = [["assert_checkbox_count", 4]]
expect = "3 items left"

[[sequence]]
description = "BUG TEST: Verify 'Test todo' appears in the list"
actions = [["assert_contains", "Test todo"]]
expect = "3 items left"

[[sequence]]
description = "BUG TEST: Input should be cleared after adding todo"
actions = [["assert_input_empty", 0]]
expect = "3 items left"

# ============================================
# SECTION 2: FILTER TESTS (with initial todos only)
# These tests run BEFORE adding dynamic todos to avoid the engine bug.
# ============================================

[[sequence]]
description = "Complete first todo (Buy groceries) for filter test"
actions = [["click_checkbox", 1]]
expect = "2 items left"

# --- ACTIVE FILTER ---
[[sequence]]
description = "Click Active filter"
actions = [["click_text", "Active"]]
expect = "Clean room"

[[sequence]]
description = "BUG TEST #C: Verify Active filter button has visible outline (focus indicator)"
actions = [["assert_button_has_outline", "Active"]]
expect = "Clean room"

[[sequence]]
description = "Verify Buy groceries is NOT visible (completed todo)"
actions = [["assert_not_contains", "Buy groceries"]]
expect = "Clean room"

[[sequence]]
description = "Items count still shows 2 (filtering doesn't change count, includes Test todo)"
expect = "2 items left"

# --- COMPLETED FILTER ---
[[sequence]]
description = "Click Completed filter"
actions = [["click_text", "Completed"]]
expect = "Buy groceries"

[[sequence]]
description = "Verify Clean room is NOT visible (active todo)"
actions = [["assert_not_contains", "Clean room"]]
expect = "Buy groceries"

# --- ALL FILTER ---
[[sequence]]
description = "Click All filter to show all todos"
actions = [["click_text", "All"]]
expect = "Buy groceries"

[[sequence]]
description = "Verify all todos visible again - Clean room"
expect = "Clean room"

# --- RESTORE STATE ---
[[sequence]]
description = "Uncheck Buy groceries to restore to 3 active"
actions = [["click_checkbox", 1]]
expect = "3 items left"

# ============================================
# SECTION 3: ADD MULTIPLE TODOS
# ============================================

[[sequence]]
description = "Add new todo (Walk the dog)"
actions = [
    ["type", "Walk the dog"],
    ["key", "Enter"]
]
expect = "Walk the dog"

[[sequence]]
description = "Verify item count shows 4"
expect = "4 items left"

[[sequence]]
description = "Add another todo (Feed the cat)"
actions = [
    ["type", "Feed the cat"],
    ["key", "Enter"]
]
expect = "Feed the cat"

[[sequence]]
description = "Verify item count shows 5"
expect = "5 items left"

# ============================================
# SECTION 4: TOGGLE ONE DYNAMIC TODO (isolation test)
# Tests that dynamically added todos have real checkboxes and can be toggled
# ============================================

[[sequence]]
description = "Toggle Test todo complete (checkbox 3 - first dynamic todo)"
actions = [["click_checkbox", 3]]
expect = "4 items left"

[[sequence]]
description = "Verify Test todo checkbox is now checked"
actions = [["assert_checkbox_checked", 3]]
expect = "4 items left"

[[sequence]]
description = "Uncheck Test todo - should restore to 5 items"
actions = [["click_checkbox", 3]]
expect = "5 items left"

# ============================================
# SECTION 5: TOGGLE COMPLETE (CHECK/UNCHECK)
# ============================================

[[sequence]]
description = "Toggle first todo complete (Buy groceries)"
actions = [["click_checkbox", 1]]
expect = "4 items left"

[[sequence]]
description = "Uncheck same todo - toggle back to active"
actions = [["click_checkbox", 1]]
expect = "5 items left"

# ============================================
# SECTION 6: TOGGLE ALL
# ============================================

[[sequence]]
description = "Toggle all todos complete using toggle_all checkbox (index 0)"
actions = [["click_checkbox", 0]]
expect = "0 items left"

# NOTE: This visual assertion is skipped for DD engine - it requires dynamic all_completed recomputation
# [[sequence]]
# description = "BUG TEST: Toggle all icon should be DARK when all todos completed"
# actions = [["assert_toggle_all_darker"]]
# expect = "0 items left"

[[sequence]]
description = "Toggle all todos back to active"
actions = [["click_checkbox", 0]]
expect = "5 items left"

# ============================================
# SECTION 6b: BUG TEST - Clear completed, add new todo, check it
# Tests that Clear completed works and new todos can be added/checked after clearing
# ============================================

[[sequence]]
description = "Toggle All to check all todos for clear test"
actions = [["click_checkbox", 0]]
expect = "0 items left"

[[sequence]]
description = "Click Clear completed to remove all todos"
actions = [["click_text", "Clear completed"]]
expect = "Double-click to edit"

[[sequence]]
description = "Add new todo 'Buy milk'"
actions = [
    ["type", "Buy milk"],
    ["key", "Enter"]
]
expect = "1 item left"

[[sequence]]
description = "BUG TEST: Check the 'Buy milk' todo - count should become 0"
actions = [["click_checkbox", 1]]
expect = "0 items left"

[[sequence]]
description = "BUG TEST: Toggle All should uncheck 'Buy milk' - count should become 1"
actions = [["click_checkbox", 0]]
expect = "1 item left"

# ============================================
# SECTION 6c: BUG TEST - New todo after double toggle
# BUG: After Toggle All twice, new todos are created already checked
# NOTE: Skipped for DD engine - depends on Section 6b which requires Clear completed
# ============================================

# [[sequence]]
# description = "Add todo after double toggle to test bug"
# actions = [
#     ["type", "Test toggle bug"],
#     ["key", "Enter"]
# ]
# expect = "Test toggle bug"

# [[sequence]]
# description = "Verify item count is 2 (new todo added)"
# expect = "2 items left"

# [[sequence]]
# description = "BUG TEST: New todo checkbox (index 2) should be UNCHECKED"
# actions = [["assert_checkbox_unchecked", 2]]
# expect = "2 items left"

# [[sequence]]
# description = "Delete test todo to restore state"
# actions = [["click_button_near_text", "Test toggle bug"]]
# expect = "1 item left"

# ============================================
# SECTION 6d: EVENT ORDERING TEST (Lamport timestamp fix)
# NOTE: Skipped for DD engine - depends on Section 6b which requires Clear completed
# ============================================
# The Lamport timestamp fix ensures DOM events (change, key_down) are processed
# in correct order. This is verified by the fact that adding todos throughout
# this test file produces correct text (not empty).

# [[sequence]]
# description = "EVENT ORDER: Add first rapid todo after interactions"
# actions = [
#     ["type", "Rapid todo 1"],
#     ["key", "Enter"]
# ]
# expect = "Rapid todo 1"

# [[sequence]]
# description = "EVENT ORDER: Verify first rapid todo has correct text (not empty)"
# expect = "2 items left"

# [[sequence]]
# description = "EVENT ORDER: Add second rapid todo immediately"
# actions = [
#     ["type", "Rapid todo 2"],
#     ["key", "Enter"]
# ]
# expect = "Rapid todo 2"

# [[sequence]]
# description = "EVENT ORDER: Verify second rapid todo has correct text"
# expect = "3 items left"

# [[sequence]]
# description = "EVENT ORDER: Add third rapid todo to verify consistency"
# actions = [
#     ["type", "Rapid todo 3"],
#     ["key", "Enter"]
# ]
# expect = "Rapid todo 3"

# [[sequence]]
# description = "EVENT ORDER: All 3 rapid todos should be present with correct text"
# expect = "4 items left"

# [[sequence]]
# description = "EVENT ORDER: Delete rapid todos to restore state"
# actions = [["click_button_near_text", "Rapid todo 3"]]
# expect = "3 items left"

# [[sequence]]
# description = "EVENT ORDER: Delete second rapid todo"
# actions = [["click_button_near_text", "Rapid todo 2"]]
# expect = "2 items left"

# [[sequence]]
# description = "EVENT ORDER: Delete first rapid todo"
# actions = [["click_button_near_text", "Rapid todo 1"]]
# expect = "1 item left"

# ============================================
# SECTION 7: CHECK DIFFERENT TODO
# After Section 6b, only "Buy milk" exists (1 item)
# ============================================

[[sequence]]
description = "Check Buy milk todo"
actions = [["click_checkbox", 1]]
expect = "0 items left"

[[sequence]]
description = "Uncheck Buy milk todo"
actions = [["click_checkbox", 1]]
expect = "1 item left"

# ============================================
# SECTION 8: EDIT TODO (DOUBLE-CLICK)
# Tests double-click editing on dynamic todos (via index-based events)
# ============================================

[[sequence]]
description = "Double-click 'Buy milk' to enter edit mode"
actions = [["dblclick_text", "Buy milk"]]
expect = "1 item left"

[[sequence]]
description = "Press Escape to cancel edit and exit edit mode"
actions = [["key", "Escape"]]
expect = "1 item left"

[[sequence]]
description = "Verify Buy milk still shows after canceling edit"
expect = "Buy milk"

# ============================================
# SECTION 10: DELETE TODO (HOVER)
# Tests hover delete button on dynamic todos (via index-based events)
# ============================================

[[sequence]]
description = "Hover over 'Buy milk' to show delete button"
actions = [["hover_text", "Buy milk"]]
expect = "1 item left"

[[sequence]]
description = "Verify delete button (×) is visible after hover"
actions = [["assert_contains", "×"]]
expect = "1 item left"

[[sequence]]
description = "Click delete button to remove 'Buy milk'"
actions = [["click_text", "×"]]
expect = "0 items left"

# ============================================
# SECTION 11: CLEAR COMPLETED
# BUG TEST #4: Clear completed must remove correct todos
# State: 0 items (Buy milk was deleted in Section 10)
# ============================================

[[sequence]]
description = "Add todo for clear completed test"
actions = [
    ["type", "Todo to complete"],
    ["key", "Enter"]
]
expect = "1 item left"

[[sequence]]
description = "Add another todo"
actions = [
    ["type", "Todo to keep"],
    ["key", "Enter"]
]
expect = "2 items left"

[[sequence]]
description = "Complete first todo for clear test (Todo to complete is checkbox 1)"
actions = [["click_checkbox", 1]]
expect = "1 item left"

[[sequence]]
description = "BUG TEST: Click Clear completed - should remove ONLY completed todo"
actions = [["click_text", "Clear completed"]]
expect = "1 item left"

[[sequence]]
description = "BUG TEST: Verify completed todo was removed"
actions = [["assert_not_contains", "Todo to complete"]]
expect = "1 item left"

[[sequence]]
description = "BUG TEST: Verify active todo is still present"
expect = "Todo to keep"

# ============================================
# SECTION 12: PERSISTENCE TESTS
# State after Section 11: "Todo to keep" (1 item)
# ============================================

[[persistence]]
description = "After re-run, should have items (LIST persisted)"
expect = "1 item left"

[[persistence]]
description = "After re-run, 'Todo to keep' should still be in list"
expect = "Todo to keep"

# ============================================
# SECTION 13: FOOTER TEXT RENDERING
# Verify footer paragraphs render correctly (not [Element])
# ============================================

[[sequence]]
description = "Footer should show 'Double-click to edit a todo'"
expect = "Double-click to edit a todo"

[[sequence]]
description = "Footer should show 'Created by Martin Kavík' (not [Element])"
expect = "Created by Martin Kavík"

[[sequence]]
description = "Footer should show 'Part of TodoMVC' (not [Element])"
expect = "Part of TodoMVC"
