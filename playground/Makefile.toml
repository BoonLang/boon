[config]
default_to_workspace = false
min_version = "0.35.13"
unstable_features = ["CTRL_C_HANDLING"]
skip_core_tasks = true

[config.modify_core_tasks]
private = true
namespace = "default"

#######  MAIN TASKS  #######

[tasks.install]
description = "Install all dependencies. It's NoOp if all deps are already installed."
dependencies = [
    "install_wasm_target", 
    "install_mzoon", 
]

[tasks.mzoon]
description = "Run MZoon"
command = "mzoon/bin/mzoon"
args = ["${@}"]

# [tasks.mzoon]
# description = "Run MZoon"
# command = "cargo"
# args = ["run", "--manifest-path", "../../MoonZoon/crates/mzoon/Cargo.toml", "${@}"]

[tasks.verify-playground]
description = "Run all playground example tests using boon-tools"
script = '''
cd ../tools && ../target/release/boon-tools exec test-examples
'''

[tasks.kill]
description = "Stop all MoonZoon development processes (mzoon, makers)"
script = '''
PORT=$(grep "^port = " MoonZoon.toml | head -1 | cut -d' ' -f3 || echo "8083")
KILLED_ANY=false

echo "Stopping development processes on port $PORT..."

# Kill process LISTENING on configured port (not browsers connecting to it)
# Using -sTCP:LISTEN to only target the server, not clients like browsers
PID=$(lsof -ti:$PORT -sTCP:LISTEN 2>/dev/null || true)
if [ -n "$PID" ]; then
    if kill -TERM $PID 2>/dev/null; then
        echo "Sent TERM signal to server on port $PORT (PID: $PID)"
        KILLED_ANY=true
    fi
fi

# Kill makers processes
if pkill -TERM -f "makers.*mzoon" 2>/dev/null; then
    echo "Sent TERM signal to makers process"
    KILLED_ANY=true
fi

# Kill mzoon processes
if pkill -TERM -f "mzoon" 2>/dev/null; then
    echo "Sent TERM signal to mzoon process"
    KILLED_ANY=true
fi

if [ "$KILLED_ANY" = "true" ]; then
    echo "Waiting 2 seconds for graceful shutdown..."
    sleep 2

    # Force kill if still running (only the LISTENING server)
    PID=$(lsof -ti:$PORT -sTCP:LISTEN 2>/dev/null || true)
    if [ -n "$PID" ]; then
        if kill -KILL $PID 2>/dev/null; then
            echo "Force killed server on port $PORT (PID: $PID)"
        fi
    fi

    pkill -KILL -f "makers.*mzoon" 2>/dev/null && echo "Force killed makers process" || true
    pkill -KILL -f "mzoon" 2>/dev/null && echo "Force killed mzoon process" || true

    echo "âœ“ Development processes terminated"
else
    echo "No development processes found to kill"
fi
'''

######  HELPER TASKS  ######

[tasks.install_wasm_target]
description = "Install Rust target `wasm32-unknown-unknown`"
command = "rustup"
args = ["target", "add", "wasm32-unknown-unknown"]

[tasks.install_mzoon]
description = "Install MoonZoon CLI (mzoon) locally"
command = "cargo"
args = [
    "install", 
    "mzoon", 
    "--git", 
    "https://github.com/MoonZoon/MoonZoon",
    "--locked",
    "--rev",
    "19c6cf6b4d07cd27bee7758977ef1ea4d5b9933d",
    "--root",
    "mzoon",
]
