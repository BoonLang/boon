# Milestone 0: Boon CLI

**Status**: Not Started

## Overview

Create a standalone Boon CLI runtime using the **new arena-based engine** (engine_v2). This enables faster development iteration, easier unit testing, and provides the foundation for M1 browser integration.

**Important:** This is NOT extraction of the old engine. M0 uses the new engine_v2 being built for M1. See `plans/M0_CLI__M1_NEW_ENGINE_IN_PLAYGROUND.md` for the combined implementation plan.

---

## Success Criteria

- [ ] `boon` CLI binary exists (`crates/boon-cli/`)
- [ ] `boon eval "expr"` evaluates inline code
- [ ] `boon run file.bn` executes files with JSON output
- [ ] `boon test` runs golden-file tests
- [ ] Timer/interval works in CLI
- [ ] File-based persistence works
- [ ] Unit tests run via standard `cargo test`

**Deferred to M4:** `boon serve` (requires WebSocket/HTTP infrastructure)

---

## Dependencies

- **Requires**: Parser (already exists in `crates/boon/src/parser/`)
- **Enables**: M1 (New Engine) - faster engine development with unit tests

---

## Rationale

The current development workflow requires:
1. Start mzoon playground server
2. Wait for WASM compilation
3. Open browser
4. Test via MCP tools or manual interaction

With a CLI:
1. Write unit test
2. Run `cargo test`
3. Iterate in seconds

This is especially valuable for developing the new arena-based engine where many small tests are needed.

---

## Key Features

| Feature | Description |
|---------|-------------|
| CLI binary | `boon run file.bn` or `boon eval "code"` |
| Golden-file testing | `boon test` compares output to expected |
| Unit testing | Standard Rust tests for engine components |
| No browser deps | Runs without Zoon/WASM |
| Same engine | Shares engine_v2 code with playground |

**Not in M0:** Server mode (`boon serve`) - deferred to M4

---

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      crates/boon/                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   src/parser/          ← Shared: lexer, parser, AST        │
│                                                             │
│   src/engine_v2/       ← NEW: Platform-agnostic engine     │
│   src/evaluator_v2/    ← NEW: AST → arena compilation      │
│                                                             │
│   src/platform/                                             │
│   ├── browser/         ← Browser-specific (Zoon bridge)    │
│   └── cli/             ← NEW: CLI-specific runtime         │
│                                                             │
└─────────────────────────────────────────────────────────────┘

crates/boon-cli/           ← NEW: CLI binary (separate crate)
```

---

## Implementation Approach

M0 is built alongside M1 using the combined plan. See `plans/M0_CLI__M1_NEW_ENGINE_IN_PLAYGROUND.md`.

### Phase 3.5: CLI Foundation (Early in M1)
- Create `platform/cli/` with platform traits
- Implement CLI timer (tokio), storage (file), logger (println)
- Create `crates/boon-cli/` with `boon eval`
- Value materialization (SlotId → JSON)

### Phase 9: CLI Completion (After M1 core)
- Implement `boon run file.bn`
- Implement `boon test` with golden-file comparison
- Add `--ticks N` / `--ms N` for timer control
- Add helpful error messages

**Why this order:** CLI in Phase 3.5 enables fast native testing for all subsequent M1 phases.

---

## CLI Commands

| Command | Description | Status |
|---------|-------------|--------|
| `boon eval "code"` | Evaluate inline code | M0 |
| `boon run file.bn` | Execute a Boon file | M0 |
| `boon test [files]` | Run golden-file tests | M0 |
| `boon check file.bn` | Type check without running | M2 |
| `boon serve` | Start server mode | M4 |
| `boon repl` | Interactive REPL | Future |

**CLI Semantics:** See `plans/M0_CLI__M1_NEW_ENGINE_IN_PLAYGROUND.md` §CLI Semantics for:
- What value to print (root binding)
- When to exit (--ticks, --ms, --until-idle)
- Test file format

---

## Platform Abstraction

**Canonical design:** See `plans/M0_CLI__M1_NEW_ENGINE_IN_PLAYGROUND.md` §Platform Traits.

The sync EventLoop needs platform support for:
1. **Timer scheduling** - `schedule_tick()`, `schedule_microtask()`
2. **Storage** - `load()`, `save()`, `remove()`
3. **Logging** - `info()`, `warn()`, `error()`

```rust
pub trait PlatformTimer {
    fn schedule_tick(&self, delay_ms: u32, callback: Box<dyn FnOnce() + 'static>);
    fn schedule_microtask(&self, callback: Box<dyn FnOnce() + 'static>);
    fn now_ms(&self) -> f64;
}

pub trait PlatformStorage {
    fn load(&self, key: &str) -> Option<String>;
    fn save(&self, key: &str, value: &str);
    fn remove(&self, key: &str);
}

pub trait PlatformLog {
    fn info(&self, msg: &str);
    fn warn(&self, msg: &str);
    fn error(&self, msg: &str);
}
```

**Platform implementations:**

| Platform | Timer | Storage | Log |
|----------|-------|---------|-----|
| CLI | tokio oneshot + sleep | File-based | `println!` |
| Browser | `queueMicrotask` / `setTimeout` | `localStorage` | `console.log` |
| Server | tokio timers | Redis/file | `tracing` |

---

## Testing Strategy

- Unit tests for each engine component
- Integration tests with `.bn` example files
- Compare CLI output with playground output
- CI runs tests on every commit

---

## Timing

This milestone can run in **parallel with M1** or even slightly before:
- Start M0 to establish CLI infrastructure
- Use CLI for rapid engine development during M1
- CLI becomes production runtime for M4 (super-counter server)

---

## Related Documentation

- §2.1-2.8 Core Engine - architecture being implemented
- §3.3 Cross-Platform - platform abstraction design
- §6.8 Protocols - serialization and communication formats
- M1 - New Engine uses CLI for testing
- M4 - Super-Counter uses CLI for server component
- M9 - Cross-platform testing extends CLI testing
