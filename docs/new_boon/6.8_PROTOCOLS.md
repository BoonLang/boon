# Chapter 6.8: Protocols

This document defines the communication protocols and data formats used across Boon platforms. All milestones reference this central specification.

---

## Value Serialization (JSON)

Boon values are serialized to JSON for persistence, debugging, and client-server communication.

### Primitive Types

| Boon Type | JSON Representation | Example |
|-----------|---------------------|---------|
| Number | `number` | `42`, `3.14` |
| Text | `string` | `"hello"` |
| Boolean | `boolean` | `true`, `false` |
| Nothing | `null` | `null` |

### Compound Types

**Object:**
```json
{
  "_type": "object",
  "fields": {
    "name": "Alice",
    "age": 30
  }
}
```

**Tagged Object:**
```json
{
  "_type": "tagged",
  "tag": "Some",
  "value": 42
}
```

**List:**
```json
{
  "_type": "list",
  "items": [1, 2, 3]
}
```

**Function (reference only, not serializable):**
```json
{
  "_type": "function",
  "id": "fn_123",
  "name": "add"
}
```

### Reactive Types

**Stream reference:**
```json
{
  "_type": "stream",
  "id": "slot_42",
  "current_value": 5
}
```

---

## Debug Protocol

Used by boon-console (M4 basic, M10 full) to inspect running Boon applications.

### Events (Runtime → Console)

**Node created:**
```json
{
  "type": "node_created",
  "id": "slot_42",
  "kind": "Register",
  "name": "counter",
  "source_location": {"line": 10, "column": 5}
}
```

**Message sent:**
```json
{
  "type": "message",
  "from": "slot_12",
  "to": "slot_42",
  "payload": {"count": 5},
  "timestamp": 1703424000000
}
```

**State changed:**
```json
{
  "type": "state_changed",
  "id": "slot_42",
  "old": {"count": 4},
  "new": {"count": 5}
}
```

**Node destroyed:**
```json
{
  "type": "node_destroyed",
  "id": "slot_42"
}
```

### Commands (Console → Runtime)

**Inspect node:**
```json
{
  "cmd": "inspect",
  "id": "slot_42"
}
```

**Response:**
```json
{
  "type": "inspect_result",
  "id": "slot_42",
  "kind": "Register",
  "value": {"count": 5},
  "subscribers": ["slot_43", "slot_44"]
}
```

**Pause/Resume:**
```json
{"cmd": "pause"}
{"cmd": "resume"}
```

**Set breakpoint:**
```json
{
  "cmd": "breakpoint",
  "action": "add",
  "id": "slot_42",
  "on": "state_change"
}
```

---

## Client-Server Protocol (WebSocket)

Used by super-counter (M4) for real-time synchronization.

### Connection

- Endpoint: `ws://host:port/boon`
- Subprotocol: `boon-sync-v1`

### Messages

**Subscribe to stream:**
```json
{
  "action": "subscribe",
  "stream": "counter",
  "request_id": "req_1"
}
```

**Subscription confirmed:**
```json
{
  "type": "subscribed",
  "stream": "counter",
  "request_id": "req_1",
  "current_value": 42
}
```

**Value update (server → client):**
```json
{
  "type": "update",
  "stream": "counter",
  "value": 43,
  "timestamp": 1703424000000
}
```

**Send event (client → server):**
```json
{
  "action": "send",
  "stream": "button_press",
  "value": {"source": "web"}
}
```

---

## FPGA Communication (UART)

Used by super-counter (M4) for FPGA ↔ Raspberry Pi communication.

### Physical Layer

- Baud rate: 115200
- Data bits: 8
- Stop bits: 1
- Parity: None
- Flow control: None

### Message Format

```
┌──────────┬──────────┬──────────────────┬──────────┐
│  START   │  LENGTH  │     PAYLOAD      │   CRC    │
│  0xAA    │  1 byte  │   N bytes        │  1 byte  │
└──────────┴──────────┴──────────────────┴──────────┘
```

### Message Types

| Type | Code | Direction | Description |
|------|------|-----------|-------------|
| BUTTON_PRESS | 0x01 | FPGA → Pi | Physical button pressed |
| COUNTER_UPDATE | 0x02 | Pi → FPGA | New counter value |
| LED_STATE | 0x03 | Pi → FPGA | Set LED on/off |
| HEARTBEAT | 0xFF | Both | Keep-alive |

### Examples

**Button press:**
```
AA 02 01 01 [CRC]  // Type=BUTTON_PRESS, button_id=1
```

**Counter update:**
```
AA 05 02 00 00 00 2A [CRC]  // Type=COUNTER_UPDATE, value=42 (little-endian u32)
```

---

## Persistence Format

Used for saving Boon application state (M1, M4, M7).

### File Format

```json
{
  "version": 1,
  "app_id": "super-counter",
  "timestamp": 1703424000000,
  "state": {
    "counter": 42,
    "last_update": "2024-12-24T12:00:00Z"
  },
  "node_states": {
    "slot_42": {"count": 42},
    "slot_43": [1, 2, 3]
  }
}
```

### Migration

When `version` changes, migration functions transform old state to new format. Details TBD as schema evolves.

---

## Related Documentation

- M4 - Super-Counter uses client-server and FPGA protocols
- M10 - boon-console uses debug protocol
- §2.5 Graph Snapshot - persistence internals
- §3.6 State Evolution - state migration
