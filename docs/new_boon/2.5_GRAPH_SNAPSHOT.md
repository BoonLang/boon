## Chapter 2.5: Graph Snapshot

### 2.5.1 Serializable State

All runtime state must be serializable.

### 2.5.2 GraphSnapshot (Full Definition)

```rust
#[derive(Serialize, Deserialize)]
pub struct GraphSnapshot {
    pub tick: u64,
    pub nodes: Vec<NodeSnapshot>,
    pub timers: Vec<(u64, NodeAddress)>,
    pub routing: SerializedRoutingTable,

    // In-flight state for restore
    pub pending_messages: Vec<Message>,           // In event queue
    pub pending_dom_events: Vec<DomEvent>,        // Buffered UI events
    pub transport_state: Vec<TransportEdgeSnapshot>,  // For reconnection
}
```

### 2.5.3 NodeSnapshot (Full Definition)

```rust
#[derive(Clone, Debug, Serialize, Deserialize)]
pub struct NodeSnapshot {
    pub address: NodeAddress,
    pub kind: NodeKindSnapshot,
    pub current_value: Option<Payload>,
    pub version: u64,
    pub dirty: bool,

    // Connections
    pub inputs: Vec<NodeAddress>,
    pub subscribers: Vec<NodeAddress>,

    // Kind-specific state
    pub state: NodeStateSnapshot,
}

#[derive(Clone, Debug, Serialize, Deserialize)]
pub enum NodeStateSnapshot {
    Producer,
    Wire,
    Router { fields: HashMap<FieldId, SlotId> },
    Bus { items: Vec<(ItemKey, SlotId)>, alloc_site: AllocSite },
    Register { stored_value: Payload },
    Combiner { last_input: Option<u8> },
    Transformer,
    SwitchedWire { current_arm: Option<usize> },
    LinkNode { bindings: Vec<LinkBindingSnapshot> },
    Timer { next_fire_ms: f64 },
    TextTemplate { template: String, cached: Option<String> },
    Effect { last_execution_tick: u64 },
}
```

### 2.5.4 Storage Strategy (Large Snapshots)

Full graph snapshot + localStorage will hit 5-10MB limit quickly.

```rust
pub enum StorageBackend {
    LocalStorage,      // Small snapshots only (<1MB)
    IndexedDB,         // Large snapshots (up to 100MB+)
    Custom(Box<dyn SnapshotStore>),
}

pub struct SnapshotConfig {
    pub backend: StorageBackend,
    pub chunking: bool,           // Split large snapshots
    pub compression: bool,        // LZ4/zstd for size reduction
    pub incremental: bool,        // Delta from last snapshot
    pub max_size_bytes: usize,    // Warn/fail if exceeded
}

impl EventLoop {
    pub fn snapshot_with_config(&self, config: &SnapshotConfig) -> Result<SnapshotId, SnapshotError> {
        let snapshot = self.snapshot();
        let serialized = if config.compression {
            compress(serialize(&snapshot))
        } else {
            serialize(&snapshot)
        };

        if serialized.len() > config.max_size_bytes {
            return Err(SnapshotError::TooLarge);
        }

        match config.backend {
            StorageBackend::LocalStorage => store_localstorage(&serialized),
            StorageBackend::IndexedDB => store_indexeddb(&serialized),
            StorageBackend::Custom(store) => store.save(&serialized),
        }
    }
}
```

### 2.5.5 Snapshot/Restore API

```rust
impl EventLoop {
    pub fn snapshot(&self) -> GraphSnapshot { ... }
    pub fn restore(&mut self, snapshot: GraphSnapshot) { ... }
}
```

**Files to modify:**
- `crates/boon/src/platform/browser/engine.rs` - Snapshot types and methods

---

