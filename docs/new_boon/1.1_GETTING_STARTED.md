# Boon Runtime Redesign: Arena-Based Reactive Dataflow Engine

## Executive Summary

Redesign Boon's runtime from Arc-heavy async actors to an arena-based, message-passing dataflow engine that:
- Eliminates heap allocations (Arc) for normal operation
- Supports multi-threaded WASM (SharedArrayBuffer + Web Workers)
- Uses hardware-inspired design patterns (not synthesizable, see Issue 3)
- Enables full graph snapshot/restore for persistence

## Design Constraints

| Constraint | Implication |
|------------|-------------|
| Multi-threaded WASM | No RefCell, thread-safe or partitioned arena |
| Hardware-inspired design | Mental model of wires/registers, NOT synthesizable (see Issue 3) |
| Full graph snapshot | All state serializable, no opaque closures |
| Frontend-only (now) | Defer distributed/backend concerns |
| Single-thread default | Multi-threaded WASM is optional (requires COOP/COEP) |

---

## "Hardware-Inspired" Design Clarification

**Important:** The design uses Vec, HashMap, VecDeque, Box, Option<Box<NodeExtension>>. This is **NOT** synthesizable to FPGA directly.

The term "hardware-inspired" means:
- **Mental model**: Nodes as registers, edges as wires, ticks as clock cycles
- **Deterministic execution**: Same inputs produce same outputs
- **Message-passing**: Like hardware signals between components
- **Eventual FPGA path**: A subset could be synthesized with restrictions

**What this design is NOT:**
- Immediately synthesizable to HDL
- Restricted to fixed sizes
- Free of heap allocation

**Future FPGA path (if needed):**
1. Restrict to static programs (no dynamic List growth)
2. Fixed-size arena allocated at compile time
3. Pre-computed routing tables
4. No Option<Box<...>> extensions

For FPGA synthesis details, see §5.1_FPGA_TRANSPILER.md and §5.3_FIXED_SIZE.md.

---

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                        Boon Program                              │
│                     (Parsed AST with NodeIds)                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Static Topology                              │
│              (Nodes + Wires from source code)                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Runtime Graph                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   Arena 0   │  │   Arena 1   │  │   Arena N   │  (Workers)   │
│  │  (Main UI)  │  │  (Compute)  │  │  (Compute)  │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                │                │                      │
│         └────────────────┼────────────────┘                      │
│                          ▼                                       │
│              ┌─────────────────────┐                             │
│              │   Message Router    │                             │
│              │   (Cross-Worker)    │                             │
│              └─────────────────────┘                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Event Loop                                   │
│  • Timer Queue (priority heap)                                   │
│  • DOM Events (from browser)                                     │
│  • Dirty Node Propagation                                        │
└─────────────────────────────────────────────────────────────────┘
```

---

