# Boon Runtime Redesign: Arena-Based Reactive Dataflow Engine

## Executive Summary

Redesign Boon's runtime from Arc-heavy async actors to an arena-based, message-passing dataflow engine that:
- Eliminates Arc<ValueActor> reactive nodes (Arc<str> for strings is acceptable, see Issue 2)
- Supports multi-threaded WASM (SharedArrayBuffer + Web Workers)
- Uses hardware-inspired design patterns (not synthesizable, see Issue 3)
- Enables full graph snapshot/restore for persistence

## Design Constraints

| Constraint | Implication |
|------------|-------------|
| Multi-threaded WASM | No RefCell, thread-safe or partitioned arena |
| Hardware-inspired design | Mental model of wires/registers, NOT synthesizable (see Issue 3) |
| Full graph snapshot | All state serializable, no opaque closures |
| Frontend-only (now) | Defer distributed/backend concerns |
| Single-thread default | Multi-threaded WASM is optional (requires COOP/COEP) |

---

## "Hardware-Inspired" Design Clarification

**Important:** The design uses Vec, HashMap, VecDeque, Box, Option<Box<NodeExtension>>. This is **NOT** synthesizable to FPGA directly.

The term "hardware-inspired" means:
- **Mental model**: Nodes as registers, edges as wires, ticks as clock cycles
- **Deterministic execution**: Same inputs produce same outputs
- **Message-passing**: Like hardware signals between components
- **Eventual FPGA path**: A subset could be synthesized with restrictions

**What this design is NOT:**
- Immediately synthesizable to HDL
- Restricted to fixed sizes
- Free of heap allocation (uses Vec, HashMap, Box - just no Arc<ValueActor>)

**Future FPGA path (if needed):**
1. Restrict to static programs (no dynamic List growth)
2. Fixed-size arena allocated at compile time
3. Pre-computed routing tables
4. No Option<Box<...>> extensions

For FPGA synthesis details, see §5.1_FPGA_TRANSPILER.md and §5.3_FIXED_SIZE.md.

---

## Key Node Types

The arena contains several node types. See §2.3 for full details.

| Node | Purpose | Hardware Analogy |
|------|---------|-----------------|
| Producer | Constant value source | Tied signal |
| Wire | Variable forwarding | Connection wire |
| Router | Object field demuxing | Demultiplexer |
| Bus | List/collection container | Shared bus |
| Register | HOLD state storage | Flip-flop/register |
| Combiner | LATEST merge | Mux with latest select |
| Transformer | THEN/WHEN/WHILE body | Combinational logic |
| TextTemplate | TEXT interpolation | String formatter (Issue 4) |
| Effect | Side-effects (Log, Navigate) | Output pad (Issue 18) |

---

## Field-Path Resolution (Alias Paths)

Boon uses alias-style field paths: `store.filter_buttons.all.event.press`

Each segment resolves to a SlotId via Router field projection:
1. `store` → SlotId of store Router
2. `.filter_buttons` → SlotId of nested Router
3. `.all` → SlotId of LinkNode
4. `.event` → SlotId of events Router
5. `.press` → SlotId of press event stream

See Issue 14 in §6.1 for implementation details.

---

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                        Boon Program                              │
│                     (Parsed AST with NodeIds)                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Static Topology                              │
│              (Nodes + Wires from source code)                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Runtime Graph                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   Arena 0   │  │   Arena 1   │  │   Arena N   │  (Workers)   │
│  │  (Main UI)  │  │  (Compute)  │  │  (Compute)  │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                │                │                      │
│         └────────────────┼────────────────┘                      │
│                          ▼                                       │
│              ┌─────────────────────┐                             │
│              │   Message Router    │                             │
│              │   (Cross-Worker)    │                             │
│              └─────────────────────┘                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Event Loop                                   │
│  • Timer Queue (priority heap)                                   │
│  • DOM Events (from browser)                                     │
│  • Dirty Node Propagation                                        │
└─────────────────────────────────────────────────────────────────┘
```

---

